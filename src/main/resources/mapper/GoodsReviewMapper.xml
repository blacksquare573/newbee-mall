<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="ltd.newbee.mall.newbeemall.dao.GoodsReviewMapper">
	<select id="findGoodsReviewByGoodsId"
		resultType="ltd.newbee.mall.newbeemall.entity.GoodsReview">
		SELECT
		re.review_id,rating,nick_name,review_date,goods_name,
		title,content,photo1,photo2,photo3,photo4,photo5,
		count(li.review_id)
		AS count
		FROM review AS re
		JOIN tb_newbee_mall_order_item as item
		ON re.goods_id=item.goods_id
		LEFT
		JOIN review_like AS li
		ON re.review_id=li.review_id
		WHERE
		item.goods_id=#{goodsId} AND proved=0
		GROUP BY re.review_id
		ORDER BY
		rating DESC
		LIMIT #{start},#{number}
	</select>

	<select id="checkGoodsReview"
		resultType="ltd.newbee.mall.newbeemall.entity.GoodsReview">
		SELECT item.order_id,item.goods_id,user_id
		FROM newbee_mall_db.tb_newbee_mall_order_item AS item
		LEFT JOIN review AS re
		ON re.order_id = item.order_id
		AND re.goods_id= item.order_id
		JOIN tb_newbee_mall_order AS o
		ON item.order_id=o.order_id
		WHERE 
		item.goods_id=#{goodsId} 
		AND re.order_id IS NOT NULL
		AND user_id=#{userId}
	</select>
	
		<insert id="insertGoodsReview">
		insert into review (review_id,order_id,goods_id,nick_name,
		rating,title,content,photo1,photo2,photo3,photo4,photo5,review_date)
		values
		<foreach item="item" collection="list" separator=",">
			(#{item.reviewId}, #{item.orderId}, #{item.goodsId}, #{item.nickName}
			, #{item.rating}, #{item.title}, #{item.content}, #{item.photo1}
			, #{item.photo2}, #{item.photo3}, #{item.photo4},#{item.photo5},#{item.reviewDate})
		</foreach>
	</insert>

</mapper>